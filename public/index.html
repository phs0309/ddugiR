<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뚜기로드: 부산 사투리 AI 챗봇</title>
    <!-- Tailwind CSS CDN을 로드하여 스타일링을 적용합니다. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Noto Sans KR)를 로드하여 한글 폰트를 적용합니다. -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 기본 바디 스타일: 폰트, 배경색, 텍스트 색상, 레이아웃 설정 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FDFBF8; /* 부드러운 미색 배경 */
            color: #343A40; /* 진한 회색 텍스트 */
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* 최소 높이를 뷰포트 높이로 설정 */
            overflow-x: hidden; /* 가로 스크롤 방지 */
        }
        /* 채팅 버블 공통 스타일 */
        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 75%; /* 최대 너비 설정 */
            word-wrap: break-word; /* 긴 단어 줄바꿈 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* 그림자 효과 */
            animation: slideInFromBottom 0.3s ease-out forwards; /* 아래에서 위로 슬라이드 인 애니메이션 */
        }
        /* 사용자 채팅 버블 스타일 */
        .chat-bubble-user {
            background-color: #E0F2F7; /* 연한 파란색 배경 */
            align-self: flex-end; /* 오른쪽 정렬 */
            margin-left: auto; /* 오른쪽 정렬 */
        }
        /* 뚜기 채팅 버블 스타일 */
        .chat-bubble-tugi {
            background-color: #FFF3CD; /* 연한 노란색 배경 */
            align-self: flex-start; /* 왼쪽 정렬 */
            margin-right: auto; /* 왼쪽 정렬 */
        }
        
        /* 뚜기 헤더 이미지 스타일 */
        .tugi-character-header {
            width: 4rem; /* 64px */
            height: 4rem;
            object-fit: contain; /* 이미지 비율 유지 */
            vertical-align: middle; /* 텍스트와 세로 정렬 */
        }
        /* 뚜기 캐릭터 애니메이션 클래스 (백엔드 응답에 따라 동적으로 적용) */
        .buki-anim-bounce { animation: bounce 0.8s ease-out forwards; }
        .buki-anim-shake { animation: shake 0.5s ease-in-out forwards; }
        .buki-anim-pulse { animation: pulse 0.8s ease-out forwards; }
        .buki-anim-wobble { animation: wobble 0.6s ease-in-out forwards; }

        /* 채팅 버블 내 큰 뚜기 이미지 스타일 및 애니메이션 */
        .tugi-large-image-in-chat {
            width: 9rem; /* 약 144px */
            height: 9rem;
            object-fit: contain;
            display: block; /* 블록 요소로 설정하여 줄바꿈 */
            margin: 0.5rem auto 0.5rem 0; /* 왼쪽 정렬 및 위아래 간격 */
            vertical-align: middle; /* (블록 요소이므로 큰 의미 없음) */
            animation: fadeInScale 0.3s ease-out forwards; /* 페이드 인 및 스케일 애니메이션 */
            opacity: 0; /* 초기에는 숨김 */
        }

        /* 채팅 내 광고 카드 스타일 */
        .in-chat-ad-card {
            background-color: #E6FFFA; /* 연한 청록색 배경 */
            border: 1px solid #B2F5EA; /* 테두리 */
            border-radius: 1rem; /* 둥근 모서리 */
            padding: 1.5rem;
            margin: 1rem auto; /* 가운데 정렬 및 상하 마진 */
            max-width: 85%;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* 그림자 */
            transition: opacity 0.5s ease-out; /* 투명도 전환 효과 */
            animation: slideInFromBottom 0.5s ease-out forwards; /* 아래에서 위로 슬라이드 인 애니메이션 */
        }
        .in-chat-ad-card.hidden {
            opacity: 0;
            pointer-events: none; /* 숨겨진 상태에서는 클릭 이벤트 무시 */
        }

        /* Keyframe 애니메이션 정의 */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes wobble { 0%, 100% { transform: translateX(0%); transform-origin: 50% 50%; } 15% { transform: translateX(-25%) rotate(-5deg); } 30% { transform: translateX(20%) rotate(3deg); } 45% { transform: translateX(-15%) rotate(-3deg); } 60% { transform: translateX(10%) rotate(2deg); } 75% { transform: translateX(-5%) rotate(-1deg); } }
        @keyframes slideInFromBottom { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes adPopIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes adPopOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.8); } }

        /* 로딩 인디케이터 점 애니메이션 */
        .loading-dots span { animation: blink 1s infinite; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
        /* 카드 페이드 인 애니메이션 */
        .card-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- 헤더 섹션: 로고/타이틀만 남김 -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm py-4">
        <div class="max-w-4xl mx-auto px-4 flex items-center justify-center"> <!-- justify-center로 변경 -->
            <span id="header-title-link" class="text-3xl font-bold text-gray-800 flex items-center cursor-pointer">
                <img id="tugi-image-header" src="https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5" alt="뚜기 캐릭터" class="tugi-character-header mr-2"> 뚜기
            </span>
            <!-- 로그인/로그아웃 버튼 제거 -->
            <nav class="flex space-x-4">
                <!-- <button id="nav-login" class="text-lg font-medium text-gray-700 hover:text-blue-600 transition-colors duration-200">로그인</button> -->
                <!-- <button id="nav-logout" class="text-lg font-medium text-gray-700 hover:text-blue-600 transition-colors duration-200 hidden">로그아웃</button> -->
            </nav>
        </div>
    </header>

    <!-- 메인 콘텐츠 영역 -->
    <main class="flex-grow max-w-4xl mx-auto w-full p-4 flex flex-col">
        <!-- 채팅 페이지 (기본적으로 표시) -->
        <div id="chat-page" class="flex-grow bg-white rounded-xl shadow-lg p-6 flex flex-col overflow-hidden">
            <!-- 채팅 메시지 표시 영역 -->
            <div id="chat-window" class="flex-grow flex flex-col space-y-4 overflow-y-auto pr-2 pb-4">
                <!-- 초기 뚜기 메시지 -->
                <div class="chat-bubble chat-bubble-tugi">
                    <p class="font-bold mb-1">뚜기</p>
                    <br>
                    <img src="https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5" alt="뚜기" class="tugi-large-image-in-chat">
                    <br>
                    <p>마! 부산은 모르는게 없는 싸나이 AI '뚜기'다. 밥 묵읏나?!</p>
                </div>

                <!-- 대화창 내 광고 카드 -->
                <div id="in-chat-ad" class="in-chat-ad-card">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">🎉 '뚜기로드' 오픈 기념 이벤트! 🎉</h3>
                    <p class="text-gray-700 mb-4">
                        지금 '뚜기'와 대화하고 부산 숨은 맛집 할인 쿠폰 받으세요!<br>
                        (기간 한정, 선착순 100명)
                    </p>
                    <img src="https://placehold.co/400x200/FFC3A0/343A40?text=이벤트+광고" alt="이벤트 광고" class="rounded-lg shadow-sm mx-auto mb-2 max-w-full h-auto">
                    <p class="text-sm text-gray-500">다음에 보기.</p>
                </div>

            </div>

            <!-- 로딩 인디케이터 -->
            <div id="loading-indicator" class="hidden text-gray-500 text-sm mt-2 mb-4">
                뚜기가 생각 중... <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
            </div>

            <!-- 맛집 추천 정보 표시 영역 -->
            <div id="recommendation-area" class="mt-4 hidden">
                <h3 class="text-xl font-bold mb-3 text-center">뚜기가 추천하는 맛집!</h3>
                <div id="restaurant-card-container" class="bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-md flex flex-col sm:flex-row items-center sm:items-start gap-4">
                    <!-- 맛집 카드는 JavaScript로 여기에 삽입됩니다. -->
                </div>
            </div>

            <!-- 사용자 입력 필드 및 전송 버튼 -->
            <div class="mt-4 flex">
                <input type="text" id="user-input" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="뚜기에게 질문하세요...">
                <button id="send-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-r-lg transition duration-200">
                    전송
                </button>
            </div>
        </div>

        <!-- 로그인 페이지 제거 -->
        <!-- <div id="login-page" class="hidden flex-grow bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">로그인</h2>
            <div class="w-full max-w-sm">
                <div id="g_id_onload"
                     data-client_id="YOUR_GOOGLE_CLIENT_ID"
                     data-callback="handleGoogleAuthResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
                
                <p id="login-status" class="mt-4 text-center text-red-500"></p>
            </div>
        </div> -->
    </main>

    <!-- 푸터 섹션 -->
    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p>&copy; 2025 뚜기. 모든 권리 보유.</p>
            <p class="text-sm text-gray-400 mt-1">Gemini API 기반 부산 사투리 챗봇</p>
        </div>
    </footer>

    <!-- Google Sign-In 플랫폼 라이브러리 제거 -->
    <!-- <script src="https://accounts.google.com/gsi/client" async defer></script> -->

    <script type="module">
        // Firebase 클라이언트 SDK 임포트 제거 (인증 관련 기능 제거)
        // import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        // import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        
        // Firebase Config 제거
        // const firebaseConfig = { ... };
        // const firebaseApp = initializeApp(firebaseConfig);
        // const auth = getAuth(firebaseApp);

        // const initialAuthToken = ...;
        // if (initialAuthToken) { ... }

        // --- DOM 요소 참조 ---
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const recommendationArea = document.getElementById('recommendation-area');
        const restaurantCardContainer = document.getElementById('restaurant-card-container');
        const tugiImageHeader = document.getElementById('tugi-image-header');
        const inChatAd = document.getElementById('in-chat-ad');

        const chatPage = document.getElementById('chat-page');
        // const loginPage = document.getElementById('login-page'); // 제거
        // const navLoginBtn = document.getElementById('nav-login'); // 제거
        // const navLogoutBtn = document.getElementById('nav-logout'); // 제거
        const headerTitleLink = document.getElementById('header-title-link');
        // const loginStatusText = document.getElementById('login-status'); // 제거

        const allPages = [chatPage]; // 로그인 페이지 제거

        let chatHistory = [];
        // let currentUser = null; // 제거

        // 뚜기 이미지 URL 맵 (프론트엔드에서도 참조)
        const tugiImageMap = {
            'default': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5',
            'recommend': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(4).png?alt=media&token=b113ec37-7c12-4b93-96fd-1818ed093f97',
            'thinking': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(Copy).png?alt=media&token=8bef4637-6651-47c0-b5a6-177d810cf9bf',
            'greeting': 'https://placehold.co/100x100/B2F5EA/343A40?text=뚜기_인사',
            'positive': 'https://placehold.co/100x100/C3F7D2/343A40?text=뚜기_긍정',
            'error': 'https://placehold.co/100x100/FF9999/343A40?text=뚜기_에러'
        };

        // 특정 페이지를 보여주고 나머지 페이지를 숨기는 함수 (이제 필요 없음, chatPage만 있으므로)
        function showPage(pageToShow) {
            allPages.forEach(page => {
                if (page === pageToShow) {
                    page.classList.remove('hidden');
                    page.classList.add('flex');
                } else {
                    page.classList.add('hidden');
                    page.classList.remove('flex');
                }
            });
            window.scrollTo(0, 0);
        }

        // Firebase 인증 상태 변경 리스너 제거
        // onAuthStateChanged(auth, (user) => { ... });

        // 채팅 메시지를 화면에 추가하는 함수
        function addMessage(sender, text, isTugi = false, tugiImageUrl = tugiImageMap['default']) {  
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isTugi ? 'chat-bubble-tugi' : 'chat-bubble-user'} mt-2`;

            if (isTugi) {
                const tugiNameParagraph = document.createElement('p');
                tugiNameParagraph.className = 'font-bold mb-1';
                tugiNameParagraph.textContent = '뚜기';

                const tugiLargeImageInChat = document.createElement('img');
                tugiLargeImageInChat.src = tugiImageUrl;
                tugiLargeImageInChat.alt = '뚜기';
                tugiLargeImageInChat.className = 'tugi-large-image-in-chat';

                const textParagraph = document.createElement('p');
                textParagraph.textContent = text;

                messageDiv.appendChild(tugiNameParagraph);
                messageDiv.appendChild(document.createElement('br'));
                messageDiv.appendChild(tugiLargeImageInChat);
                messageDiv.appendChild(document.createElement('br'));
                messageDiv.appendChild(textParagraph);

                tugiImageHeader.src = tugiImageUrl;
                tugiImageHeader.classList.remove('buki-anim-bounce', 'buki-anim-shake', 'buki-anim-pulse', 'buki-anim-wobble');

                let animationClass = '';
                if (tugiImageUrl.includes('뚜기_추천')) {
                    animationClass = 'buki-anim-bounce';
                } else if (tugiImageUrl.includes('뚜기_생각')) {
                    animationClass = 'buki-anim-wobble';
                } else if (tugiImageUrl.includes('뚜기_인사')) {
                    animationClass = 'buki-anim-bounce';
                } else if (tugiImageUrl.includes('뚜기_긍정')) {
                    animationClass = 'buki-anim-pulse';
                } else if (tugiImageUrl.includes('뚜기_에러')) {
                    animationClass = 'buki-anim-shake';
                } else {
                    animationClass = 'buki-anim-pulse';
                }

                if (animationClass) {
                    tugiImageHeader.classList.add(animationClass);
                    setTimeout(() => {
                        tugiImageHeader.classList.remove(animationClass);
                    }, 800);
                }

            } else {
                messageDiv.innerHTML = `<p class="font-bold mb-1">나</p><p>${text}</p>`;
            }

            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function displayRestaurantCard(restaurantData) {
            if (!restaurantData) {
                recommendationArea.classList.add('hidden');
                restaurantCardContainer.innerHTML = '';
                return;
            }

            recommendationArea.classList.remove('hidden');
            recommendationArea.classList.add('card-fade-in');

            restaurantCardContainer.innerHTML = `
                <img src="${restaurantData.image_url || 'https://placehold.co/400x300/CCCCCC/FFFFFF?text=No+Image'}" alt="${restaurantData.name} 이미지" class="w-full sm:w-40 h-32 sm:h-auto object-cover rounded-lg shadow-sm">
                <div class="flex-grow">
                    <h4 class="text-lg font-bold text-blue-700 mb-1">${restaurantData.name} (${restaurantData.location})</h4>
                    <p class="text-gray-700 text-sm">${restaurantData.desc}</p>
                    <a href="https://www.google.com/maps/search/${encodeURIComponent(restaurantData.name + ' 부산 ' + restaurantData.location)}" target="_blank" class="text-blue-500 hover:underline text-sm mt-2 inline-block">
                        지도에서 보기 ↗
                    </a>
                </div>
            `;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // 사용자 메시지 전송 함수
        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            // 로그인 체크 로직 제거
            // if (!currentUser) { ... return; }

            if (!inChatAd.classList.contains('hidden')) {
                inChatAd.classList.add('hidden');
            }

            addMessage('user', message);
            userInput.value = '';
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            recommendationArea.classList.add('hidden');
            recommendationArea.classList.remove('card-fade-in');

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            try {
                // ID 토큰 가져오는 로직 제거
                // const idToken = await currentUser.getIdToken();

                // TODO: 여기에 당신의 Cloud Function URL을 입력하세요.
                const backendApiBaseUrl = 'https://us-central1-ddugidata.cloudfunctions.net/api'; // <-- 이 부분을 실제 URL로 교체!

                const response = await fetch(`${backendApiBaseUrl}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': `Bearer ${idToken}` // Authorization 헤더 제거
                    },
                    body: JSON.stringify({ message: message, history: chatHistory })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '네트워크 응답이 좋지 않습니다.');
                }

                const data = await response.json();
                const tugiResponseImageUrl = data.tugi_image_url || tugiImageMap['default'];
                addMessage('tugi', data.reply, true, tugiResponseImageUrl);

                chatHistory.push({ role: "model", parts: [{ text: data.reply }] });

                if (data.restaurant) {
                    displayRestaurantCard(data.restaurant);
                } else {
                    displayRestaurantCard(null);
                }

            } catch (error) {
                console.error('메시지 전송 중 오류 발생:', error);
                // 인증 오류 메시지 처리 로직 제거
                // if (error.message.includes('인증되지 않은 요청') || error.message.includes('유효하지 않은 인증 토큰')) { ... } else { ... }
                addMessage('tugi', '뚜기가 잠시 멍 때리고 있심더... 다시 말 걸어주이소.', true, tugiImageMap['error']);
                displayRestaurantCard(null);
            } finally {
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        inChatAd.addEventListener('click', () => {
            if (!inChatAd.classList.contains('hidden')) {
                inChatAd.classList.add('hidden');
            }
        });

        // Google Sign-In Callback 함수 제거
        // window.handleGoogleAuthResponse = async (response) => { ... };

        // 로그아웃 로직 제거
        // navLogoutBtn.addEventListener('click', async () => { ... });

        // 내비게이션 이벤트 리스너 (로그인 버튼 관련 제거)
        // navLoginBtn.addEventListener('click', () => showPage(loginPage));
        headerTitleLink.addEventListener('click', () => showPage(chatPage));

        // 초기 페이지 로드 시 채팅 페이지를 표시합니다.
        showPage(chatPage);
    </script>
</body>
</html>
