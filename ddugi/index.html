<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëšœê¸°ë¡œë“œ: ë¶€ì‚° ì‚¬íˆ¬ë¦¬ AI ì±—ë´‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FDFBF8;
            color: #343A40;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 75%;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            animation: slideInFromBottom 0.3s ease-out forwards;
        }
        .chat-bubble-user {
            background-color: #E0F2F7;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-bubble-tugi { /* í´ë˜ìŠ¤ëª… ë³€ê²½ */
            background-color: #FFF3CD;
            align-self: flex-start;
            margin-right: auto;
        }
        
        /* ëšœê¸° í—¤ë” ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .tugi-character-header {
            width: 4rem; /* 64px */
            height: 4rem;
            object-fit: contain; /* ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ */
            vertical-align: middle;
        }
        /* ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ëŠ” ê·¸ëŒ€ë¡œ ì ìš© */
        .buki-anim-bounce { /* í´ë˜ìŠ¤ëª…ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
            animation: bounce 0.8s ease-out forwards;
        }
        .buki-anim-shake {
            animation: shake 0.5s ease-in-out forwards;
        }
        .buki-anim-pulse {
            animation: pulse 0.8s ease-out forwards;
        }
        .buki-anim-wobble {
            animation: wobble 0.6s ease-in-out forwards;
        }

        /* ì±„íŒ… ë²„ë¸” ë‚´ í° ëšœê¸° ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ë° ì• ë‹ˆë©”ì´ì…˜ */
        .tugi-large-image-in-chat {
            width: 9rem; /* ì•½ 40px */
            height: 9rem;
            object-fit: contain;
            display: block; /* í•µì‹¬ ë³€ê²½: í•­ìƒ ì¤„ë°”ê¿ˆ ë˜ë„ë¡ */
            margin: 0.5rem auto 0.5rem 0; /* ì™¼ìª½ ì •ë ¬ ë° ìœ„ì•„ë˜ ê°„ê²© */
            vertical-align: middle; /* blockì´ë¯€ë¡œ í° ì˜ë¯¸ ì—†ìŒ */
            animation: fadeInScale 0.3s ease-out forwards;
            opacity: 0; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        }

        .in-chat-ad-card {
            background-color: #E6FFFA;
            border: 1px solid #B2F5EA;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem auto;
            max-width: 85%;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: opacity 0.5s ease-out;
            animation: slideInFromBottom 0.5s ease-out forwards;
        }
        .in-chat-ad-card.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Keyframe ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes wobble {
            0%, 100% { transform: translateX(0%); transform-origin: 50% 50%; }
            15% { transform: translateX(-25%) rotate(-5deg); }
            30% { transform: translateX(20%) rotate(3deg); }
            45% { transform: translateX(-15%) rotate(-3deg); }
            60% { transform: translateX(10%) rotate(2deg); }
            75% { transform: translateX(-5%) rotate(-1deg); }
        }
        @keyframes slideInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes adPopIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes adPopOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }

        .loading-dots span {
            animation: blink 1s infinite;
        }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        .card-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm py-4">
        <div class="max-w-4xl mx-auto px-4 flex items-center justify-between">
            <span id="header-title-link" class="text-3xl font-bold text-gray-800 flex items-center cursor-pointer">
                <img id="tugi-image-header" src="https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5" alt="ëšœê¸° ìºë¦­í„°" class="tugi-character-header mr-2"> ëšœê¸°
            </span>
            <nav class="flex space-x-4">
                <button id="nav-login" class="text-lg font-medium text-gray-700 hover:text-blue-600 transition-colors duration-200">ë¡œê·¸ì¸</button>
                <button id="nav-logout" class="text-lg font-medium text-gray-700 hover:text-blue-600 transition-colors duration-200 hidden">ë¡œê·¸ì•„ì›ƒ</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto w-full p-4 flex flex-col">
        <!-- Chat Page -->
        <div id="chat-page" class="flex-grow bg-white rounded-xl shadow-lg p-6 flex flex-col overflow-hidden">
            <!-- Chat Window -->
            <div id="chat-window" class="flex-grow flex flex-col space-y-4 overflow-y-auto pr-2 pb-4">
                <div class="chat-bubble chat-bubble-tugi">
                    <p class="font-bold mb-1">ëšœê¸°</p>
                    <br>
                    <!-- ì´ˆê¸° ë©”ì‹œì§€ì˜ í° ëšœê¸° ì´ë¯¸ì§€ ì¶”ê°€ -->
                    <img src="https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5" alt="ëšœê¸°" class="tugi-large-image-in-chat">
                    <br>
                    <p>ë§ˆ! ë¶€ì‚°ì€ ëª¨ë¥´ëŠ”ê²Œ ì—†ëŠ” ì‹¸ë‚˜ì´ AI 'ëšœê¸°'ë‹¤. ë°¥ ë¬µìë‚˜?!</p>
                </div>

                <!-- ëŒ€í™”ì°½ ë‚´ ê´‘ê³  (ì´ˆê¸° ë©”ì‹œì§€ ë‹¤ìŒ) -->
                <div id="in-chat-ad" class="in-chat-ad-card">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ‰ 'ëšœê¸°ë¡œë“œ' ì˜¤í”ˆ ê¸°ë… ì´ë²¤íŠ¸! ğŸ‰</h3>
                    <p class="text-gray-700 mb-4">
                        ì§€ê¸ˆ 'ëšœê¸°'ì™€ ëŒ€í™”í•˜ê³  ë¶€ì‚° ìˆ¨ì€ ë§›ì§‘ í• ì¸ ì¿ í° ë°›ìœ¼ì„¸ìš”!<br>
                        (ê¸°ê°„ í•œì •, ì„ ì°©ìˆœ 100ëª…)
                    </p>
                    <img src="https://placehold.co/400x200/FFC3A0/343A40?text=ì´ë²¤íŠ¸+ê´‘ê³ " alt="ì´ë²¤íŠ¸ ê´‘ê³ " class="rounded-lg shadow-sm mx-auto mb-2 max-w-full h-auto">
                    <p class="text-sm text-gray-500">ë‹¤ìŒì— ë³´ê¸°.</p>
                </div>

            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden text-gray-500 text-sm mt-2 mb-4">
                ëšœê¸°ê°€ ìƒê° ì¤‘... <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
            </div>

            <!-- Restaurant Recommendation Display Area -->
            <div id="recommendation-area" class="mt-4 hidden">
                <h3 class="text-xl font-bold mb-3 text-center">ëšœê¸°ê°€ ì¶”ì²œí•˜ëŠ” ë§›ì§‘!</h3>
                <div id="restaurant-card-container" class="bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-md flex flex-col sm:flex-row items-center sm:items-start gap-4">
                    <!-- Restaurant card will be injected here -->
                </div>
            </div>

            <!-- User Input -->
            <div class="mt-4 flex">
                <input type="text" id="user-input" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ëšœê¸°ì—ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”...">
                <button id="send-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-r-lg transition duration-200">
                    ì „ì†¡
                </button>
            </div>
        </div>

        <!-- Login Page (hidden by default) -->
        <div id="login-page" class="hidden flex-grow bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ë¡œê·¸ì¸</h2>
            <div class="w-full max-w-sm">
                <!-- Google Sign-In Button -->
                <div id="g_id_onload"
                     data-client_id="YOUR_GOOGLE_CLIENT_ID" <!-- TODO: YOUR_GOOGLE_CLIENT_IDë¡œ êµì²´í•˜ì„¸ìš” -->
                     data-callback="handleGoogleAuthResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>

                <div class="my-4 text-gray-500">- ë˜ëŠ” -</div>

                <!-- Kakao Login Button -->
                <a id="kakao-login-btn" href="javascript:void(0)" class="block">
                    <img src="https://k.kakaocdn.net/14/dn/btqCn0vtPt0/RxBn9YmImEZw2BEEzT8jVG/o.jpg" class="w-full max-w-[222px] mx-auto rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200" alt="ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼"/>
                </a>
                
                <p id="login-status" class="mt-4 text-center text-red-500"></p>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p>&copy; 2025 ëšœê¸°. ëª¨ë“  ê¶Œë¦¬ ë³´ìœ .</p>
            <p class="text-sm text-gray-400 mt-1">Gemini API ê¸°ë°˜ ë¶€ì‚° ì‚¬íˆ¬ë¦¬ ì±—ë´‡</p>
        </div>
    </footer>

    <!-- Google Sign-In Platform Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Kakao JavaScript SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

    <script type="module">
        // Firebase í´ë¼ì´ì–¸íŠ¸ SDK ì„í¬íŠ¸ (ì¸ì¦ ìƒíƒœ ê´€ë¦¬ë¥¼ ìœ„í•´ í•„ìš”)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        // FirestoreëŠ” ë°±ì—”ë“œì—ì„œ ì£¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” í•„ìš” ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // TODO: Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ì‹¤ì œ êµ¬ì„± ê°ì²´ë¡œ YOUR_FIREBASE_CONFIGë¥¼ êµì²´í•˜ì„¸ìš”.
        // Canvas í™˜ê²½ì—ì„œëŠ” __firebase_config ë³€ìˆ˜ê°€ ìë™ìœ¼ë¡œ ì£¼ì…ë˜ì§€ë§Œ, ì¼ë°˜ HTML íŒŒì¼ì—ì„œëŠ” ì§ì ‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // TODO: ì‹¤ì œ Firebase Web API Keyë¡œ êµì²´
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);

        // Canvas í™˜ê²½ì—ì„œ ì´ˆê¸° ì¸ì¦ í† í°ì´ ì œê³µë  ê²½ìš° ì‚¬ìš©
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken)
                .then(() => console.log('Initial auth token signed in.'))
                .catch(error => console.error('Initial auth token sign-in failed:', error));
        } else {
             // Canvas í™˜ê²½ì´ ì•„ë‹ˆê±°ë‚˜ í† í°ì´ ì—†ëŠ” ê²½ìš° ìµëª… ë¡œê·¸ì¸ ì‹œë„ (ì„ íƒ ì‚¬í•­)
             // signInAnonymously(auth).then(() => console.log('Signed in anonymously')).catch(error => console.error('Anonymous sign-in failed:', error));
        }

        // --- DOM ìš”ì†Œ ì°¸ì¡° ---
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const recommendationArea = document.getElementById('recommendation-area');
        const restaurantCardContainer = document.getElementById('restaurant-card-container');
        const tugiImageHeader = document.getElementById('tugi-image-header');
        const inChatAd = document.getElementById('in-chat-ad');

        const chatPage = document.getElementById('chat-page');
        const loginPage = document.getElementById('login-page');
        const navLoginBtn = document.getElementById('nav-login');
        const navLogoutBtn = document.getElementById('nav-logout'); // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const headerTitleLink = document.getElementById('header-title-link');
        const loginStatusText = document.getElementById('login-status'); // ë¡œê·¸ì¸ ìƒíƒœ ë©”ì‹œì§€

        const allPages = [chatPage, loginPage];

        let chatHistory = [];
        let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´

        // ëšœê¸° ì´ë¯¸ì§€ URL ë§µ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ ì°¸ì¡°)
        const tugiImageMap = {
            'default': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5', // ê¸°ë³¸ ëšœê¸°
            'recommend': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(4).png?alt=media&token=b113ec37-7c12-4b93-96fd-1818ed093f97', // ë§›ì§‘ ì¶”ì²œ ì‹œ ë°˜ì§ì´
            'thinking': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(Copy).png?alt=media&token=8bef4637-6651-47c0-b5a6-177d810cf9bf',   // ìƒê°/ëª¨í˜¸í•  ë•Œ
            'greeting': 'https://placehold.co/100x100/B2F5EA/343A40?text=ëšœê¸°_ì¸ì‚¬',   // ì¸ì‚¬í•  ë•Œ
            'positive': 'https://placehold.co/100x100/C3F7D2/343A40?text=ëšœê¸°_ê¸ì •',   // ê¸ì •/ê°ì‚¬í•  ë•Œ
            'error': 'https://placehold.co/100x100/FF9999/343A40?text=ëšœê¸°_ì—ëŸ¬'    // ì˜¤ë¥˜ ë°œìƒ ì‹œ
        };

        // Function to show a specific page and hide others
        function showPage(pageToShow) {
            allPages.forEach(page => {
                if (page === pageToShow) {
                    page.classList.remove('hidden');
                    page.classList.add('flex'); // Ensure flex display for content centering
                } else {
                    page.classList.add('hidden');
                    page.classList.remove('flex');
                }
            });
            window.scrollTo(0, 0); // Scroll to top of the new page
        }

        // --- Firebase Authentication State Listener ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log('User is logged in:', user.uid, user.email);
                navLoginBtn.classList.add('hidden');
                navLogoutBtn.classList.remove('hidden');
                loginStatusText.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.displayName || user.email || user.uid}!`;
                loginStatusText.classList.remove('text-red-500');
                loginStatusText.classList.add('text-green-600');
                showPage(chatPage); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™
            } else {
                console.log('User is logged out.');
                navLoginBtn.classList.remove('hidden');
                navLogoutBtn.classList.add('hidden');
                loginStatusText.textContent = 'ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
                loginStatusText.classList.remove('text-green-600');
                loginStatusText.classList.add('text-red-500');
            }
        });

        // --- Message Display Functions ---
        function addMessage(sender, text, isTugi = false, tugiImageUrl = tugiImageMap['default']) { Â 
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isTugi ? 'chat-bubble-tugi' : 'chat-bubble-user'} mt-2`;

            if (isTugi) {
                const tugiNameParagraph = document.createElement('p');
                tugiNameParagraph.className = 'font-bold mb-1';
                tugiNameParagraph.textContent = 'ëšœê¸°';

                const tugiLargeImageInChat = document.createElement('img');
                tugiLargeImageInChat.src = tugiImageUrl;
                tugiLargeImageInChat.alt = 'ëšœê¸°';
                tugiLargeImageInChat.className = 'tugi-large-image-in-chat';

                const textParagraph = document.createElement('p');
                textParagraph.textContent = text;

                messageDiv.appendChild(tugiNameParagraph);
                messageDiv.appendChild(document.createElement('br'));
                messageDiv.appendChild(tugiLargeImageInChat);
                messageDiv.appendChild(document.createElement('br'));
                messageDiv.appendChild(textParagraph);

                tugiImageHeader.src = tugiImageUrl;
                tugiImageHeader.classList.remove('buki-anim-bounce', 'buki-anim-shake', 'buki-anim-pulse', 'buki-anim-wobble');

                let animationClass = '';
                if (tugiImageUrl.includes('ëšœê¸°_ì¶”ì²œ')) {
                    animationClass = 'buki-anim-bounce';
                } else if (tugiImageUrl.includes('ëšœê¸°_ìƒê°')) {
                    animationClass = 'buki-anim-wobble';
                } else if (tugiImageUrl.includes('ëšœê¸°_ì¸ì‚¬')) {
                    animationClass = 'buki-anim-bounce';
                } else if (tugiImageUrl.includes('ëšœê¸°_ê¸ì •')) {
                    animationClass = 'buki-anim-pulse';
                } else if (tugiImageUrl.includes('ëšœê¸°_ì—ëŸ¬')) {
                    animationClass = 'buki-anim-shake';
                } else {
                    animationClass = 'buki-anim-pulse';
                }

                if (animationClass) {
                    tugiImageHeader.classList.add(animationClass);
                    setTimeout(() => {
                        tugiImageHeader.classList.remove(animationClass);
                    }, 800);
                }

            } else {
                messageDiv.innerHTML = `<p class="font-bold mb-1">ë‚˜</p><p>${text}</p>`;
            }

            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function displayRestaurantCard(restaurantData) {
            if (!restaurantData) {
                recommendationArea.classList.add('hidden');
                restaurantCardContainer.innerHTML = '';
                return;
            }

            recommendationArea.classList.remove('hidden');
            recommendationArea.classList.add('card-fade-in');

            restaurantCardContainer.innerHTML = `
                <img src="${restaurantData.image_url || 'https://placehold.co/400x300/CCCCCC/FFFFFF?text=No+Image'}" alt="${restaurantData.name} ì´ë¯¸ì§€" class="w-full sm:w-40 h-32 sm:h-auto object-cover rounded-lg shadow-sm">
                <div class="flex-grow">
                    <h4 class="text-lg font-bold text-blue-700 mb-1">${restaurantData.name} (${restaurantData.location})</h4>
                    <p class="text-gray-700 text-sm">${restaurantData.desc}</p>
                    <a href="https://www.google.com/maps/search/${encodeURIComponent(restaurantData.name + ' ë¶€ì‚° ' + restaurantData.location)}" target="_blank" class="text-blue-500 hover:underline text-sm mt-2 inline-block">
                        ì§€ë„ì—ì„œ ë³´ê¸° â†—
                    </a>
                </div>
            `;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- Chat Message Sending Logic ---
        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            if (!inChatAd.classList.contains('hidden')) {
                inChatAd.classList.add('hidden');
            }

            addMessage('user', message);
            userInput.value = '';
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            recommendationArea.classList.add('hidden');
            recommendationArea.classList.remove('card-fade-in');

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            try {
                const response = await fetch('http://localhost:3000/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message, history: chatHistory })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();
                const tugiResponseImageUrl = data.tugi_image_url || tugiImageMap['default'];
                addMessage('tugi', data.reply, true, tugiResponseImageUrl);

                chatHistory.push({ role: "model", parts: [{ text: data.reply }] });

                if (data.restaurant) {
                    displayRestaurantCard(data.restaurant);
                } else {
                    displayRestaurantCard(null);
                }

            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                addMessage('tugi', 'ëšœê¸°ê°€ ì ì‹œ ë© ë•Œë¦¬ê³  ìˆì‹¬ë”... ë‹¤ì‹œ ë§ ê±¸ì–´ì£¼ì´ì†Œ.', true, tugiImageMap['error']);
                displayRestaurantCard(null);
            } finally {
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        inChatAd.addEventListener('click', () => {
            if (!inChatAd.classList.contains('hidden')) {
                inChatAd.classList.add('hidden');
            }
        });

        // --- Google Sign-In Callback ---
        window.handleGoogleAuthResponse = async (response) => {
            console.log("Google ID Token:", response.credential);
            loginStatusText.textContent = 'Google ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...';
            try {
                const backendResponse = await fetch('http://localhost:3000/auth/google', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ idToken: response.credential })
                });

                if (!backendResponse.ok) {
                    const errorData = await backendResponse.json();
                    throw new Error(errorData.error || 'Google ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤íŒ¨');
                }

                const data = await backendResponse.json();
                console.log('Backend Google Auth Success:', data);
                // Firebase í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì»¤ìŠ¤í…€ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸
                await signInWithCustomToken(auth, data.customToken);
                loginStatusText.textContent = 'Google ë¡œê·¸ì¸ ì„±ê³µ!';
                showPage(chatPage); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™
            } catch (error) {
                console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                loginStatusText.textContent = `Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`;
            }
        };

       

        // --- Logout Logic ---
        navLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('User signed out from Firebase.');
                loginStatusText.textContent = 'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.';
                showPage(loginPage); // ë¡œê·¸ì•„ì›ƒ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                chatHistory = []; // ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™”
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                loginStatusText.textContent = `ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`;
            }
        });

        // --- Navigation Event Listeners ---
        navLoginBtn.addEventListener('click', () => showPage(loginPage));
        headerTitleLink.addEventListener('click', () => showPage(chatPage)); // Click 'ëšœê¸°' title to go to chat page

        // Initial page load: show chat page
        showPage(chatPage);
    </script>
</body>
</html>
