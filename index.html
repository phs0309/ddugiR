<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뚜기로드: 부산 사투리 AI 챗봇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FDFBF8;
            color: #343A40;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 75%;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            animation: slideInFromBottom 0.3s ease-out forwards;
        }
        .chat-bubble-user {
            background-color: #E0F2F7;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-bubble-tugi { /* 클래스명 변경 */
            background-color: #FFF3CD;
            align-self: flex-start;
            margin-right: auto;
        }
        
        /* 뚜기 헤더 이미지 스타일 */
        .tugi-character-header {
            width: 4rem; /* 64px */
            height: 4rem;
            object-fit: contain; /* 이미지 비율 유지 */
            vertical-align: middle;
        }
        /* 애니메이션 클래스는 그대로 적용 */
        .buki-anim-bounce { /* 클래스명은 그대로 유지 */
            animation: bounce 0.8s ease-out forwards;
        }
        .buki-anim-shake {
            animation: shake 0.5s ease-in-out forwards;
        }
        .buki-anim-pulse {
            animation: pulse 0.8s ease-out forwards;
        }
        .buki-anim-wobble {
            animation: wobble 0.6s ease-in-out forwards;
        }

        /* 채팅 버블 내 큰 뚜기 이미지 스타일 및 애니메이션 */
        .tugi-large-image-in-chat {
            width: 9rem; /* 약 40px */
            height: 9rem;
            object-fit: contain;
            display: block; /* 핵심 변경: 항상 줄바꿈 되도록 */
            margin: 0.5rem auto 0.5rem 0; /* 왼쪽 정렬 및 위아래 간격 */
            vertical-align: middle; /* block이므로 큰 의미 없음 */
            animation: fadeInScale 0.3s ease-out forwards;
            opacity: 0; /* 초기에는 숨김 */
        }

        .in-chat-ad-card {
            background-color: #E6FFFA;
            border: 1px solid #B2F5EA;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem auto;
            max-width: 85%;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: opacity 0.5s ease-out;
            animation: slideInFromBottom 0.5s ease-out forwards;
        }
        .in-chat-ad-card.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Keyframe 애니메이션 정의 */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes wobble {
            0%, 100% { transform: translateX(0%); transform-origin: 50% 50%; }
            15% { transform: translateX(-25%) rotate(-5deg); }
            30% { transform: translateX(20%) rotate(3deg); }
            45% { transform: translateX(-15%) rotate(-3deg); }
            60% { transform: translateX(10%) rotate(2deg); }
            75% { transform: translateX(-5%) rotate(-1deg); }
        }
        @keyframes slideInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes adPopIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes adPopOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }

        .loading-dots span {
            animation: blink 1s infinite;
        }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        .card-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm py-4">
        <div class="max-w-4xl mx-auto px-4 flex items-center justify-between">
            <span id="header-title-link" class="text-3xl font-bold text-gray-800 flex items-center cursor-pointer">
                <img id="tugi-image-header" src="https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5" alt="뚜기 캐릭터" class="tugi-character-header mr-2"> 뚜기
            </span>
            <nav class="flex space-x-4">
                <button id="nav-login" class="text-lg font-medium text-gray-700 hover:text-blue-600 transition-colors duration-200">로그인</button>
                <button id="nav-logout" class="text-lg font-medium text-gray-700 hover:text-blue-600 transition-colors duration-200 hidden">로그아웃</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto w-full p-4 flex flex-col">
        <!-- Chat Page -->
        <div id="chat-page" class="flex-grow bg-white rounded-xl shadow-lg p-6 flex flex-col overflow-hidden">
            <!-- Chat Window -->
            <div id="chat-window" class="flex-grow flex flex-col space-y-4 overflow-y-auto pr-2 pb-4">
                <div class="chat-bubble chat-bubble-tugi">
                    <p class="font-bold mb-1">뚜기</p>
                    <br>
                    <!-- 초기 메시지의 큰 뚜기 이미지 추가 -->
                    <img src="https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5" alt="뚜기" class="tugi-large-image-in-chat">
                    <br>
                    <p>마! 부산은 모르는게 없는 싸나이 AI '뚜기'다. 밥 묵읏나?!</p>
                </div>

                <!-- 대화창 내 광고 (초기 메시지 다음) -->
                <div id="in-chat-ad" class="in-chat-ad-card">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">🎉 '뚜기로드' 오픈 기념 이벤트! 🎉</h3>
                    <p class="text-gray-700 mb-4">
                        지금 '뚜기'와 대화하고 부산 숨은 맛집 할인 쿠폰 받으세요!<br>
                        (기간 한정, 선착순 100명)
                    </p>
                    <img src="https://placehold.co/400x200/FFC3A0/343A40?text=이벤트+광고" alt="이벤트 광고" class="rounded-lg shadow-sm mx-auto mb-2 max-w-full h-auto">
                    <p class="text-sm text-gray-500">다음에 보기.</p>
                </div>

            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden text-gray-500 text-sm mt-2 mb-4">
                뚜기가 생각 중... <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
            </div>

            <!-- Restaurant Recommendation Display Area -->
            <div id="recommendation-area" class="mt-4 hidden">
                <h3 class="text-xl font-bold mb-3 text-center">뚜기가 추천하는 맛집!</h3>
                <div id="restaurant-card-container" class="bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-md flex flex-col sm:flex-row items-center sm:items-start gap-4">
                    <!-- Restaurant card will be injected here -->
                </div>
            </div>

            <!-- User Input -->
            <div class="mt-4 flex">
                <input type="text" id="user-input" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="뚜기에게 질문하세요...">
                <button id="send-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-r-lg transition duration-200">
                    전송
                </button>
            </div>
        </div>

        <!-- Login Page (hidden by default) -->
        <div id="login-page" class="hidden flex-grow bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">로그인</h2>
            <div class="w-full max-w-sm">
                <!-- Google Sign-In Button -->
                <div id="g_id_onload"
                     data-client_id="YOUR_GOOGLE_CLIENT_ID" <!-- TODO: YOUR_GOOGLE_CLIENT_ID로 교체하세요 -->
                     data-callback="handleGoogleAuthResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>

                <div class="my-4 text-gray-500">- 또는 -</div>

                <!-- Kakao Login Button -->
                <a id="kakao-login-btn" href="javascript:void(0)" class="block">
                    <img src="https://k.kakaocdn.net/14/dn/btqCn0vtPt0/RxBn9YmImEZw2BEEzT8jVG/o.jpg" class="w-full max-w-[222px] mx-auto rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200" alt="카카오 로그인 버튼"/>
                </a>
                
                <p id="login-status" class="mt-4 text-center text-red-500"></p>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p>&copy; 2025 뚜기. 모든 권리 보유.</p>
            <p class="text-sm text-gray-400 mt-1">Gemini API 기반 부산 사투리 챗봇</p>
        </div>
    </footer>

    <!-- Google Sign-In Platform Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Kakao JavaScript SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

    <script type="module">
        // Firebase 클라이언트 SDK 임포트 (인증 상태 관리를 위해 필요)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        // Firestore는 백엔드에서 주로 처리하므로 프론트엔드에서는 필요 없을 수 있습니다.
        // import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // TODO: Firebase 콘솔에서 복사한 실제 구성 객체로 YOUR_FIREBASE_CONFIG를 교체하세요.
        // Canvas 환경에서는 __firebase_config 변수가 자동으로 주입되지만, 일반 HTML 파일에서는 직접 입력해야 합니다.
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // TODO: 실제 Firebase Web API Key로 교체
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);

        // Canvas 환경에서 초기 인증 토큰이 제공될 경우 사용
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken)
                .then(() => console.log('Initial auth token signed in.'))
                .catch(error => console.error('Initial auth token sign-in failed:', error));
        } else {
             // Canvas 환경이 아니거나 토큰이 없는 경우 익명 로그인 시도 (선택 사항)
             // signInAnonymously(auth).then(() => console.log('Signed in anonymously')).catch(error => console.error('Anonymous sign-in failed:', error));
        }

        // --- DOM 요소 참조 ---
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const recommendationArea = document.getElementById('recommendation-area');
        const restaurantCardContainer = document.getElementById('restaurant-card-container');
        const tugiImageHeader = document.getElementById('tugi-image-header');
        const inChatAd = document.getElementById('in-chat-ad');

        const chatPage = document.getElementById('chat-page');
        const loginPage = document.getElementById('login-page');
        const navLoginBtn = document.getElementById('nav-login');
        const navLogoutBtn = document.getElementById('nav-logout'); // 로그아웃 버튼
        const headerTitleLink = document.getElementById('header-title-link');
        const loginStatusText = document.getElementById('login-status'); // 로그인 상태 메시지

        const allPages = [chatPage, loginPage];

        let chatHistory = [];
        let currentUser = null; // 현재 로그인된 사용자 정보

        // 뚜기 이미지 URL 맵 (프론트엔드에서도 참조)
        const tugiImageMap = {
            'default': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(2)%20(1).png?alt=media&token=b3754220-4e08-4925-852b-1bb862b9fca5', // 기본 뚜기
            'recommend': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(4).png?alt=media&token=b113ec37-7c12-4b93-96fd-1818ed093f97', // 맛집 추천 시 반짝이
            'thinking': 'https://firebasestorage.googleapis.com/v0/b/ddugidata.firebasestorage.app/o/Untitled%20(Copy).png?alt=media&token=8bef4637-6651-47c0-b5a6-177d810cf9bf',   // 생각/모호할 때
            'greeting': 'https://placehold.co/100x100/B2F5EA/343A40?text=뚜기_인사',   // 인사할 때
            'positive': 'https://placehold.co/100x100/C3F7D2/343A40?text=뚜기_긍정',   // 긍정/감사할 때
            'error': 'https://placehold.co/100x100/FF9999/343A40?text=뚜기_에러'    // 오류 발생 시
        };

        // Function to show a specific page and hide others
        function showPage(pageToShow) {
            allPages.forEach(page => {
                if (page === pageToShow) {
                    page.classList.remove('hidden');
                    page.classList.add('flex'); // Ensure flex display for content centering
                } else {
                    page.classList.add('hidden');
                    page.classList.remove('flex');
                }
            });
            window.scrollTo(0, 0); // Scroll to top of the new page
        }

        // --- Firebase Authentication State Listener ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log('User is logged in:', user.uid, user.email);
                navLoginBtn.classList.add('hidden');
                navLogoutBtn.classList.remove('hidden');
                loginStatusText.textContent = `환영합니다, ${user.displayName || user.email || user.uid}!`;
                loginStatusText.classList.remove('text-red-500');
                loginStatusText.classList.add('text-green-600');
                showPage(chatPage); // 로그인 성공 시 채팅 페이지로 이동
            } else {
                console.log('User is logged out.');
                navLoginBtn.classList.remove('hidden');
                navLogoutBtn.classList.add('hidden');
                loginStatusText.textContent = '로그인해주세요.';
                loginStatusText.classList.remove('text-green-600');
                loginStatusText.classList.add('text-red-500');
            }
        });

        // --- Message Display Functions ---
        function addMessage(sender, text, isTugi = false, tugiImageUrl = tugiImageMap['default']) {  
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isTugi ? 'chat-bubble-tugi' : 'chat-bubble-user'} mt-2`;

            if (isTugi) {
                const tugiNameParagraph = document.createElement('p');
                tugiNameParagraph.className = 'font-bold mb-1';
                tugiNameParagraph.textContent = '뚜기';

                const tugiLargeImageInChat = document.createElement('img');
                tugiLargeImageInChat.src = tugiImageUrl;
                tugiLargeImageInChat.alt = '뚜기';
                tugiLargeImageInChat.className = 'tugi-large-image-in-chat';

                const textParagraph = document.createElement('p');
                textParagraph.textContent = text;

                messageDiv.appendChild(tugiNameParagraph);
                messageDiv.appendChild(document.createElement('br'));
                messageDiv.appendChild(tugiLargeImageInChat);
                messageDiv.appendChild(document.createElement('br'));
                messageDiv.appendChild(textParagraph);

                tugiImageHeader.src = tugiImageUrl;
                tugiImageHeader.classList.remove('buki-anim-bounce', 'buki-anim-shake', 'buki-anim-pulse', 'buki-anim-wobble');

                let animationClass = '';
                if (tugiImageUrl.includes('뚜기_추천')) {
                    animationClass = 'buki-anim-bounce';
                } else if (tugiImageUrl.includes('뚜기_생각')) {
                    animationClass = 'buki-anim-wobble';
                } else if (tugiImageUrl.includes('뚜기_인사')) {
                    animationClass = 'buki-anim-bounce';
                } else if (tugiImageUrl.includes('뚜기_긍정')) {
                    animationClass = 'buki-anim-pulse';
                } else if (tugiImageUrl.includes('뚜기_에러')) {
                    animationClass = 'buki-anim-shake';
                } else {
                    animationClass = 'buki-anim-pulse';
                }

                if (animationClass) {
                    tugiImageHeader.classList.add(animationClass);
                    setTimeout(() => {
                        tugiImageHeader.classList.remove(animationClass);
                    }, 800);
                }

            } else {
                messageDiv.innerHTML = `<p class="font-bold mb-1">나</p><p>${text}</p>`;
            }

            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function displayRestaurantCard(restaurantData) {
            if (!restaurantData) {
                recommendationArea.classList.add('hidden');
                restaurantCardContainer.innerHTML = '';
                return;
            }

            recommendationArea.classList.remove('hidden');
            recommendationArea.classList.add('card-fade-in');

            restaurantCardContainer.innerHTML = `
                <img src="${restaurantData.image_url || 'https://placehold.co/400x300/CCCCCC/FFFFFF?text=No+Image'}" alt="${restaurantData.name} 이미지" class="w-full sm:w-40 h-32 sm:h-auto object-cover rounded-lg shadow-sm">
                <div class="flex-grow">
                    <h4 class="text-lg font-bold text-blue-700 mb-1">${restaurantData.name} (${restaurantData.location})</h4>
                    <p class="text-gray-700 text-sm">${restaurantData.desc}</p>
                    <a href="https://www.google.com/maps/search/${encodeURIComponent(restaurantData.name + ' 부산 ' + restaurantData.location)}" target="_blank" class="text-blue-500 hover:underline text-sm mt-2 inline-block">
                        지도에서 보기 ↗
                    </a>
                </div>
            `;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- Chat Message Sending Logic ---
        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            if (!inChatAd.classList.contains('hidden')) {
                inChatAd.classList.add('hidden');
            }

            addMessage('user', message);
            userInput.value = '';
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            recommendationArea.classList.add('hidden');
            recommendationArea.classList.remove('card-fade-in');

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            try {
                const response = await fetch('http://localhost:3000/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message, history: chatHistory })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '네트워크 응답이 좋지 않습니다.');
                }

                const data = await response.json();
                const tugiResponseImageUrl = data.tugi_image_url || tugiImageMap['default'];
                addMessage('tugi', data.reply, true, tugiResponseImageUrl);

                chatHistory.push({ role: "model", parts: [{ text: data.reply }] });

                if (data.restaurant) {
                    displayRestaurantCard(data.restaurant);
                } else {
                    displayRestaurantCard(null);
                }

            } catch (error) {
                console.error('메시지 전송 중 오류 발생:', error);
                addMessage('tugi', '뚜기가 잠시 멍 때리고 있심더... 다시 말 걸어주이소.', true, tugiImageMap['error']);
                displayRestaurantCard(null);
            } finally {
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        inChatAd.addEventListener('click', () => {
            if (!inChatAd.classList.contains('hidden')) {
                inChatAd.classList.add('hidden');
            }
        });

        // --- Google Sign-In Callback ---
        window.handleGoogleAuthResponse = async (response) => {
            console.log("Google ID Token:", response.credential);
            loginStatusText.textContent = 'Google 로그인 처리 중...';
            try {
                const backendResponse = await fetch('http://localhost:3000/auth/google', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ idToken: response.credential })
                });

                if (!backendResponse.ok) {
                    const errorData = await backendResponse.json();
                    throw new Error(errorData.error || 'Google 로그인 처리 실패');
                }

                const data = await backendResponse.json();
                console.log('Backend Google Auth Success:', data);
                // Firebase 클라이언트에서 커스텀 토큰으로 로그인
                await signInWithCustomToken(auth, data.customToken);
                loginStatusText.textContent = 'Google 로그인 성공!';
                showPage(chatPage); // 로그인 성공 시 채팅 페이지로 이동
            } catch (error) {
                console.error('Google 로그인 오류:', error);
                loginStatusText.textContent = `Google 로그인 실패: ${error.message}`;
            }
        };

       

        // --- Logout Logic ---
        navLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('User signed out from Firebase.');
                loginStatusText.textContent = '로그아웃되었습니다.';
                showPage(loginPage); // 로그아웃 후 로그인 페이지로 이동
                chatHistory = []; // 대화 기록 초기화
            } catch (error) {
                console.error('로그아웃 오류:', error);
                loginStatusText.textContent = `로그아웃 실패: ${error.message}`;
            }
        });

        // --- Navigation Event Listeners ---
        navLoginBtn.addEventListener('click', () => showPage(loginPage));
        headerTitleLink.addEventListener('click', () => showPage(chatPage)); // Click '뚜기' title to go to chat page

        // Initial page load: show chat page
        showPage(chatPage);
    </script>
</body>
</html>
